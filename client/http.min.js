/*
 * cvideo - v0.0.1 - 2013-04-12
 * Copyright (c) 2013 Alejandro Morales; Licensed  
 */
(function(c){'use strict';function a(){}function b(a){a||(a={}),this._timeout=a.timeout||1e4,this._resolve='resolve'in a&&a.resolve!==!0?!1:!0,this._queue=[],this.data=[],this.called=!1;}a.create=function(b){return new a(b);},a.prototype._listeners={},a.prototype.emit=function(a){if(!this._listeners[a])return this;var b=[].slice.call(arguments,1);this._listeners[a].forEach(function(a){try{a.apply(this,b);}catch(a){console.log('ERROR executing function',a.stack);}},this);},a.prototype.on=a.prototype.bind=function(a,b){return this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b),this;},b.prototype=Object.create(a.prototype,{constructor:b}),b.prototype.add=function(a){return this.called&&(this.called=!1),this._resolve&&!this._queue.length?(this._queue.push(1),this.emit('task',a),a(this._resolver.bind(this)),this):this._queue.length||!this._resolve?(this._queue.push(a),this):void 0;},b.prototype._resolver=function(b,c){(b||c)&&(this.emit('task:resolved',b,c),this.data.push([b,c]));var a=this._queue.shift();return a||this._end(this.data),typeof a==='number'?this._resolver():typeof a!=='function'?this._end(this.data):a(this._resolver.bind(this));},b.prototype.resolve=function(a){this.on('resolve',a);},b.prototype._end=function(a){this.called||(this.called=!0,this.emit('resolve',a));},c.Kue=b,c.Events=a;}(window),!function(g,c,e){function a(a,b){var c=this;if(a=a||document.querySelector('canvas'),!a)throw new Error('no canvas in the DOM');if(typeof a.toDataURL!=='function')throw new Error('You need to provide a valid canvas');b||(b={}),this._job=+new Date,this._canvas=a,this._frames=[],this._failed=[],this._sended=[],this._kue=new Kue,this._kue.on('taskr',function(a){c.emit('progress',a);});}function f(){if(typeof DEBUG==='undefined')return;console.log.apply(console,arguments);}function b(b){var a=document.body;b?a.removeAttribute('data-loading'):a.setAttribute('data-loading','');}function d(a,f){function g(){b(1),a.callback&&a.callback(c),f&&f(c);}b();var c=new XMLHttpRequest,d=a.method||'GET',h=a.data||{},g;a.headers=a.headers||{},c.open(d,a.url,!a.sync),d!=='GET'&&!a.headers['Content-type']&&!a.headers['Content-Type']&&c.setRequestHeader('Content-type','application/json');for(var e in a.headers)c.setRequestHeader(e,a.headers[e]);return c.onreadystatechange=function(){c.readyState===4&&g(c);},c.send(d==='GET'?null:h),c;}function h(b,e){var c=b.width;var d=b.height;var a=b.getContext('2d');var f;if(e){f=a.getImageData(0,0,c,d);var g=a.globalCompositeOperation;a.globalCompositeOperation='destination-over',a.fillStyle=e,a.fillRect(0,0,c,d);}var h=b.toDataURL('image/png').substr(22);return e&&(a.clearRect(0,0,c,d),a.putImageData(f,0,0),a.globalCompositeOperation=g),h;}c=0,e=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,16.666666666666668);};}(),a.create=function(b,c){return new a(b,c);},a.prototype=Object.create(Events.prototype,{constructor:a}),Object.defineProperty(a.prototype,'STATUS',{get:function(){return c;},set:function(a){this.emit('status',a),c=a;}}),a.prototype.start,a.prototype.init=function(b){var a=this;return this._kue.add(function(c){d({method:'POST',url:'/canvas/video/start',data:JSON.stringify({id:this._job,author:this._author||'anon'}),callback:function(d){d=JSON.parse(d.response),a.STATUS=1,a._frame(),b&&b(d),c(null,d);}});}),this;},a.prototype._frame=function(){var a=this;if(a.STATUS!==1)return;e(function(){a._frame();});var b=h(a._canvas,a._background||'white');a._frames.push(b),a._frames.length%100===0&&a._sendPacket(a._frames.length);},a.prototype.pause=function(){return this.STATUS=0,this;},a.prototype.resume=function(){return this.STATUS=1,this._frame(),this;},a.prototype._sendPacket=function(b,e,c){e||(e=100);var a={id:this._job,frames:this._frames.slice(b-e,b),packet:b/100},g=this;this._kue.add(function(e){d({method:'POST',url:'/canvas/video/frames',data:JSON.stringify(a),callback:function(d){if(d=JSON.parse(d.response),d.status==='ok')return f('Packet sended: %d',a.packet),c&&c(null,d),e(null,d),g._sended.push(a.packet);f('Packet failed: %d',a.packet),c&&c(d),e(d,null),g._failed.push(b);}});});},a.prototype.sendMissingFrames=function(){this._failed.map(function(a){return this._sendPacket(a),null;},this);},a.prototype.convertToVideo=function(e){var a=this._frames.length%100,c=this,f;b(),c.STATUS=2,a!==0&&this._sendPacket(a,a,function(a){d({url:'/canvas/video/encode',method:'POST',data:JSON.stringify({id:c._job}),callback:function(a){f=a=JSON.parse(a.response),b(1),c.emit('end',f),a.status==='ok'?e(null,a):e(a);}});});},g.CanvasVideo=a;}(window));