/*
 * cvideo - v0.0.1 - 2013-04-11
 * Copyright (c) 2013 Alejandro Morales; Licensed  
 */
(function(c){'use strict';function a(){}function b(a){a||(a={}),this._timeout=a.timeout||1e4,this._resolve='resolve'in a&&a.resolve!==!0?!1:!0,this._queue=[],this.data=[],this.called=!1;}a.create=function(b){return new a(b);},a.prototype._listeners={},a.prototype.emit=function(a){if(!this._listeners[a])return this;var b=[].slice.call(arguments,1);this._listeners[a].forEach(function(a){try{a.apply(this,b);}catch(a){console.log('ERROR executing function',a.stack);}},this);},a.prototype.on=a.prototype.bind=function(a,b){return this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b),this;},b.prototype=Object.create(a.prototype,{constructor:b}),b.prototype.add=function(a){return this.called&&(this.called=!1),this._resolve&&!this._queue.length?(this._queue.push(1),this.emit('task',a),a(this._resolver.bind(this)),this):this._queue.length||!this._resolve?(this._queue.push(a),this):void 0;},b.prototype._resolver=function(b,c){(b||c)&&(this.emit('task:resolved',b,c),this.data.push([b,c]));var a=this._queue.shift();return a||this._end(this.data),typeof a==='number'?this._resolver():typeof a!=='function'?this._end(this.data):a(this._resolver.bind(this));},b.prototype.resolve=function(a){this.on('resolve',a);},b.prototype._end=function(a){this.called||(this.called=!0,this.emit('resolve',a));},c.Kue=b,c.Events=a;}(window),!function(e,c){function d(){console.log.apply(console,arguments);}function a(a){var b=this;if(a=a||document.querySelector('canvas'),!a)throw new Error('no canvas in the DOM');if(typeof a.toDataURL!=='function')throw new Error('You need to provide a valid canvas');this._job=+new Date,this._canvas=a,this._frames=[],this._failed=[],this._sended=[],this._kue=new Kue,this._kue.on('taskr',function(a){b.emit('progress',a);});}function b(a,e){function f(){document.body.removeAttribute('data-loading'),a.callback&&a.callback(b),e&&e(b);}document.body.setAttribute('data-loading','');var b=new XMLHttpRequest,c=a.method||'GET',g=a.data||{},f;a.headers=a.headers||{},b.open(c,a.url,!a.sync),c!=='GET'&&!a.headers['Content-type']&&!a.headers['Content-Type']&&b.setRequestHeader('Content-type','application/json');for(var d in a.headers)b.setRequestHeader(d,a.headers[d]);return b.onreadystatechange=function(){b.readyState===4&&f(b);},b.send(c==='GET'?null:g),b;}function f(b,e){var c=b.width;var d=b.height;var a=b.getContext('2d');var f;if(e){f=a.getImageData(0,0,c,d);var g=a.globalCompositeOperation;a.globalCompositeOperation='destination-over',a.fillStyle=e,a.fillRect(0,0,c,d);}var h=b.toDataURL('image/png').substr(22);return e&&(a.clearRect(0,0,c,d),a.putImageData(f,0,0),a.globalCompositeOperation=g),h;}c=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,16.666666666666668);};}(),a.create=function(b){return new a(b);},a.prototype=Object.create(Events.prototype,{constructor:a}),a.prototype.start,a.prototype.init=function(c){var a=this;return this._kue.add(function(d){b({method:'POST',url:'/canvas/video/start',data:JSON.stringify({id:this._job,author:this._author||'anon'}),callback:function(b){b=JSON.parse(b.response),a._frame(),a.STATUS=1,c&&c(b),d(null,b);}});}),this;},a.prototype._frame=function(){var a=this;if(a.STATUS===0)return;c(function(){a._frame();});var b=f(a._canvas,a._background||'white');a._frames.push(b),a._frames.length%100===0&&a._sendPacket(a._frames.length);},a.prototype._sendPacket=function(c,f,e){f||(f=100);var a={id:this._job,frames:this._frames.slice(c-f,c),packet:c/100},g=this;this._kue.add(function(f){b({method:'POST',url:'/canvas/video/frames',data:JSON.stringify(a),callback:function(b){if(b=JSON.parse(b.response),b.status==='ok')return d('Packet sended: %d',a.packet),e&&e(null,b),f(null,b),g._sended.push(a.packet);d('Packet failed: %d',a.packet),e&&e(b),f(b,null),g._failed.push(c);}});});},a.prototype.sendMissingFrames=function(){this._failed.map(function(a){return this._sendPacket(a),null;},this);},a.prototype.convertToVideo=function(d){var a=this._frames.length%100,c=this,e;c.STATUS=0,a!==0&&this._sendPacket(a,a,function(a){b({url:'/canvas/video/encode',method:'POST',data:JSON.stringify({id:c._job}),callback:function(a){e=a=JSON.parse(a.response),a.status==='ok'?d(null,a):d(a);}});});},e.CanvasVideo=a;}(window));